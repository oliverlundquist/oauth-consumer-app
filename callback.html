<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>OAuth2 Consumer App</title>
	<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgo=">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<base href="/">
	<style>
		.product-card {
			display:inline-block;
			padding:10px;
			border:1px solid #000;
			margin-right:10px;
			vertical-align: top;
		}
		.product-card img {
			width: 200px;
			height: auto;
			display:block;
		}
	</style>
</head>
<body>
	<div id="container"></div>
	<script src="https://s3-eu-west-1.amazonaws.com/mystore-api-auth-app/assets/jquery-3.1.0.min.js"></script>
	<script src="https://s3-eu-west-1.amazonaws.com/mystore-api-auth-app/assets/jquery-query-vars.js"></script>
	<script>
		(function (storage, redirect) {
			var url, data, token;

			if ((token = storage.getItem('token')) === null) {
				getToken();
			} else {
				getProducts();
			}

			function getToken() {
				url = 'https://auth.mystore.no/oauth/authorize';

				data = {};
				data.grant_type    = 'authorization_code';
				data.client_id     = 0;  // 1. set app client id
				data.client_secret = ''; // 2. set your app secret
				data.redirect_uri  = ''; // 3. set the redirect_uri for your app
				data.code          = decodeURIComponent($.getUrlVar('code')) || '';

				$.post(url, data)
					.then(function(response) {
						token = response.access_token;
						storage.setItem('token', response.access_token);
						getProducts();
					})
					.catch(function() {
						redirect.href = ''; // 4. set redirect on error
					});
			}

			function getProducts() {
				$.ajax({
						url: '', // 5. set resource url to the resource you want to fetch
						headers: {
							'Authorization': 'Bearer ' + token,
							'Access-Control-Allow-Headers': 'Authorization'
						}
					})
					.then(function(response) {
						render(response.data);
					})
					.catch(function() {
						storage.removeItem('token');
						redirect.href = ''; // 6. set redirect on error
					});
			}

			function render(data) {
				data.forEach(function (datum) {
					$('<div>', { class: 'product-card' })
						.html(
							'<img src="' + datum.attributes.image + '" />' +
							datum.attributes.name.no + '<br>' +
							datum.attributes.name.se + '<br>' +
							datum.attributes.price + ' NOK'
						)
						.appendTo('#container');
				});
			}

		})(window.localStorage, window.location);
	</script>
</body>
</html>
